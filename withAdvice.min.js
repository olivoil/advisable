/**
 * withAdvice
 * Copyright(c) 2012 Olivier Melcher <olivier.melcher@gmail.com>
 * MIT Licensed
 */!function(root){"use strict";function withAdvice(){return this.before=before,this.after=after,this.around=around,slice.call(arguments).forEach(function(mixin){mixin.call(this)},this),this}function extend(obj){return slice.call(arguments,1).forEach(function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj}function before(name,fn,error){return addAdvice(this,name,fn,{error:error,type:"before"}),this}function after(name,fn,error){return addAdvice(this,name,fn,{error:error,type:"after"}),this}function addAdvice(obj,name,advice,options){setupAdvice(obj,name),extend(advice,options),obj._withAdvice[name][options.type].push(advice)}function AdviceStack(){this.storage=[],this.asyncCount=0}function setupAdvice(obj,name){if(typeof obj._withAdvice=="undefined"){obj._withAdvice={},obj._withAdvice[name]={before:new AdviceStack,after:new AdviceStack};var fn=obj[name]||noop;obj[name]=function(){var suite=new AdviceSuite(this,name,fn,arguments);return suite.run()}}}function AdviceSuite(ctx,name,fn,args){this.ctx=ctx,this.name=name,this.fn=fn,this.args=slice.call(args),typeof args[args.length-1]=="function"&&(this.errorFallback=args[args.length-1])}function around(method,advice){var fn=this[method];return this[method]=function(){var args=[fn];return push.apply(args,arguments),advice.apply(this,args)},this}var array=[],slice=array.slice,push=array.push,filter=array.filter,noop=function(){};typeof exports=="undefined"?root.withAdvice=withAdvice:module.exports=withAdvice,withAdvice.version="0.0.8",AdviceStack.prototype.push=function(advice){this.storage.push(advice),!advice.length||this.asyncCount++},AdviceStack.prototype.get=function(num){return this.storage[num]},AdviceStack.prototype.getLength=function(){return this.storage.length},AdviceSuite.prototype.run=function(){return this.stack=this.ctx._withAdvice[this.name].before,this.adviceCount=this.stack.getLength(),this.asyncLeft=this.stack.asyncCount,this.next()},AdviceSuite.prototype.done=function(){if(arguments[0]instanceof Error)return this.handleError(arguments[0],this.getCurrentAdvice());var res=this.fn.apply(this.ctx,this.args);return this.stack=this.ctx._withAdvice[this.name].after,this.asyncLeft=this.stack.asyncCount,this.next=function(){if(arguments[0]instanceof Error)return this.handleError(arguments[0],this.getCurrentAdvice());if(++this.adviceCount<this.stack.getLength()){var advice=this.getCurrentAdvice(),args=this.adviceArguments(advice);return advice.apply(this.ctx,args)}return res},this.next()},AdviceSuite.prototype.next=function(){if(arguments[0]instanceof Error)return this.handleError(arguments[0],this.getCurrentAdvice());if(--this.adviceCount>=0){var advice=this.getCurrentAdvice(),args=this.adviceArguments(advice);return advice.apply(this.ctx,args)}return this.done()},AdviceSuite.prototype.getCurrentAdvice=function(){var advice=this.stack.get(this.adviceCount);if(advice.length===0){var suite=this;return function(){try{return advice.apply(suite.ctx,arguments),suite.next()}catch(e){suite.handleError(e,advice)}}}return advice},AdviceSuite.prototype.handleError=function(err,advice){if(typeof advice.error=="function")return advice.error.call(this.ctx,err);if(typeof this.errorFallback=="function")return this.errorFallback.call(this.ctx,err);throw err},AdviceSuite.prototype.asyncDone=function(advice){return function(err){return err&&err instanceof Error?this.handleError(err,advice):--this.asyncLeft?this.next():this.done()}},AdviceSuite.prototype.adviceArguments=function(advice){if(advice.length===0)return this.args;if(advice.length===1)return[this.next.bind(this)].concat(this.args);if(advice.length>=2)return[this.next.bind(this),this.asyncDone(advice).bind(this)].concat(this.args)}}(this);