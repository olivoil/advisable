/**
 * withAdvice
 * Copyright(c) 2012 Olivier Melcher <olivier.melcher@gmail.com>
 * MIT Licensed
 */!function(root){function withAdvice(){return this.before=before,this.after=after,this.around=around,slice.call(arguments).forEach(function(mixin){mixin.call(this)},this),this}function extend(obj){return slice.call(arguments,1).forEach(function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj}function before(name,fn,error,timeout){return typeof timeout=="undefined"&&typeof error!="function"&&(timeout=error,error=void 0),addAdvice(this,name,extend(fn,{async:!!fn.length,error:error,timeout:timeout,type:"before"})),this}function AdviceStack(){this.storage=[],this.asyncCount=0}function addAdvice(obj,name,advice){setupAdvice(obj,name),obj[name]._withAdvice[advice.type].push(advice)}function setupAdvice(obj,name){typeof obj[name]._withAdvice=="undefined"&&(setupMiddlewareEngine(obj,name),setupMiddlewareStorage(obj,name))}function setupMiddlewareStorage(obj,name){obj[name]._withAdvice={before:new AdviceStack}}function handleError(err,advice,fallback){if(typeof advice.error=="function")return advice.error.call(this,err);if(typeof fallback=="function")return fallback(err);throw err}function setupMiddlewareEngine(obj,name){var fn=obj[name];obj[name]=function(){var adviceArgs,currentAdvice,self=this,lastArg=arguments[arguments.length-1],beforeStack=obj[name]._withAdvice.before,afterStack=obj[name]._withAdvice.after,current=beforeStack.length,beforeAdviceLeft=beforeStack.length,next=function(){if(arguments[0]instanceof Error)return handleError.call(this,arguments[0],beforeStack.get(current),lastArg);var args=slice.call(arguments),currentAdvice,adviceArgs;args.length&&(arguments[0]!=null||typeof lastArg!="function")&&(adviceArgs=args);if(--current>=0){currentAdvice=beforeStack.get(current);if(currentAdvice.async)adviceArgs=(currentAdvice.length>1?[once(next),once(beforeAsyncDone)]:[once(next)]).concat(adviceArgs);else{var curr=currentAdvice;currentAdvice=function(){try{curr.apply(this)}catch(e){return handleError.call(self,e,curr,lastArg)}return next.apply(this)}}return currentAdvice.apply(self,adviceArgs)}return done.apply(self,adviceArgs)},done=function(){var args=slice.call(arguments),result=fn.apply(self,args);return result};if(beforeAdviceLeft)function beforeAsyncDone(err){if(err&&err instanceof Error)return handleError(err,advice,lastArg);--beforeAdviceLeft||done.apply(self,adviceArgs)}return next.apply(this,arguments)}}function once(fn,ctx){return ctx||(ctx=this),function e(){if(fnWrapper.called)return;fnWrapper.called=!0,fn.apply(ctx,arguments)}}function after(method,aspect){this[method]=doAfter(aspect,this[method])}function doAfter(aspect,fn){return function(){var args=slice.call(arguments),result=fn.apply(this,args);return result&&args.unshift(result),aspect.apply(this,args)||result}}function around(method,aspect){this[method]=doAround(aspect,this[method])}function doAround(aspect,fn){return function(){var args=[fn];return push.apply(args,arguments),aspect.apply(this,args)}}var array=[],slice=array.slice,push=array.push,filter=array.filter;typeof exports=="undefined"?root.withAdvice=withAdvice:module.exports=withAdvice,withAdvice.version="0.0.6",withAdvice.before=before,AdviceStack.prototype={push:function(advice){this.storage.push(advice),advice.async&&this.asyncCount++},get:function(num){if(typeof num=="function"){var res,storage=this.storage,iterator=function(advice){advice._wrapped===num};return storage.forEach(function(advice){iterator(advice)&&typeof res=="undefined"&&(res=advice)}),res}return this.storage[num]},isEmpty:function(){return!!this.storage.length},get length(){return this.storage.length}},withAdvice.after=after,withAdvice.around=around}(this);